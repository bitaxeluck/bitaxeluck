# BitAxeLuck Telegraf Configuration
# ================================
# This config collects metrics from your BitAxe and sends them to BitAxeLuck
#
# SETUP:
# 1. Replace BITAXE_IP with your BitAxe's local IP (e.g., 192.168.1.50)
# 2. Replace YOUR_API_TOKEN with your BitAxeLuck API token
# 3. Run: telegraf --config telegraf.conf

# Global settings
[agent]
  interval = "10s"
  round_interval = true
  metric_batch_size = 1000
  metric_buffer_limit = 10000
  collection_jitter = "0s"
  flush_interval = "10s"
  flush_jitter = "0s"
  precision = "0s"
  hostname = ""
  omit_hostname = true

# =============================================================================
# INPUT: Read from BitAxe API
# =============================================================================
[[inputs.http]]
  urls = ["http://BITAXE_IP/api/system/info"]
  timeout = "5s"
  method = "GET"
  data_format = "json"

  # Name of the measurement
  name_override = "miner_metrics"

  # Fields to collect (mining metrics)
  json_query = ""

  # Map JSON fields to InfluxDB fields
  tagexclude = ["*"]

  # Extract specific fields
  fielddrop = ["ssid", "stratumUser", "fallbackStratumUser", "macAddr", "hostname", "version", "idfVersion", "runningPartition", "scriptsig"]

# =============================================================================
# PROCESSOR: Rename fields to match BitAxeLuck expected format
# =============================================================================
[[processors.rename]]
  [[processors.rename.replace]]
    field = "hashRate"
    dest = "hashrate"

  [[processors.rename.replace]]
    field = "temp"
    dest = "temperature"

  [[processors.rename.replace]]
    field = "vrTemp"
    dest = "vr_temperature"

  [[processors.rename.replace]]
    field = "fanrpm"
    dest = "fan_rpm"

  [[processors.rename.replace]]
    field = "fanspeed"
    dest = "fan_speed"

  [[processors.rename.replace]]
    field = "sharesAccepted"
    dest = "shares_accepted"

  [[processors.rename.replace]]
    field = "sharesRejected"
    dest = "shares_rejected"

  [[processors.rename.replace]]
    field = "bestDiff"
    dest = "best_diff"

  [[processors.rename.replace]]
    field = "bestSessionDiff"
    dest = "best_session_diff"

  [[processors.rename.replace]]
    field = "poolDifficulty"
    dest = "pool_difficulty"

  [[processors.rename.replace]]
    field = "coreVoltage"
    dest = "core_voltage"

  [[processors.rename.replace]]
    field = "coreVoltageActual"
    dest = "core_voltage_actual"

  [[processors.rename.replace]]
    field = "uptimeSeconds"
    dest = "uptime"

  [[processors.rename.replace]]
    field = "freeHeap"
    dest = "free_heap"

# =============================================================================
# PROCESSOR: Convert hashrate from GH/s to H/s (BitAxeLuck expects H/s)
# =============================================================================
[[processors.starlark]]
  source = '''
def apply(metric):
    # Convert GH/s to H/s
    if "hashrate" in metric.fields:
        metric.fields["hashrate"] = metric.fields["hashrate"] * 1000000000
    if "hashRate_1m" in metric.fields:
        metric.fields["hashrate_1m"] = metric.fields["hashRate_1m"] * 1000000000
        del metric.fields["hashRate_1m"]
    if "hashRate_10m" in metric.fields:
        metric.fields["hashrate_10m"] = metric.fields["hashRate_10m"] * 1000000000
        del metric.fields["hashRate_10m"]
    if "hashRate_1h" in metric.fields:
        metric.fields["hashrate_1h"] = metric.fields["hashRate_1h"] * 1000000000
        del metric.fields["hashRate_1h"]
    return metric
'''

# =============================================================================
# OUTPUT: Send to BitAxeLuck
# =============================================================================
[[outputs.influxdb_v2]]
  urls = ["https://influx.bitaxeluck.com"]
  token = "YOUR_API_TOKEN"
  organization = "hashluck"
  bucket = "miners"

  # Timeout settings
  timeout = "10s"

  # Skip TLS verification if needed (not recommended for production)
  # insecure_skip_verify = true

# =============================================================================
# OPTIONAL: Debug output to console
# =============================================================================
# Uncomment to see metrics in console
# [[outputs.file]]
#   files = ["stdout"]
#   data_format = "influx"
